# SMF-Android-Fastlane-Commons

## Lanes

### Pullrequest Checks ``` smf_pr_check ```

Updates project data such as the Jenkinsfile based on the ``` Config.json ``` and perform checks using the lane ``` smf_danger_build_pr ```

| Parameter | Required | Note  |
|---|---|---|
| danger | true | map of danger parameters (see ``` smf_danger_build_pr ```) |

```ruby
smf_pr_check(
  danger: {
    "modules" => [
      {
        "gradle_build_task" => "assembleDebug",
        "gradle_lint_task" => "lintDebug",
        "module_name" => "app",
        "run_detekt" => true,
        "run_ktlint" => true,
        "junit_task" => "testDebugUnitTest"
      }
    ] 
  }
)
```

### Increment Buildnumber ``` smf_increment_build_number ```
Parameter:  

| Parameter | Required | Note  |
|---|---|---|
| build_variant | true |  |
| branch | true |   |
| modulePropertiesFile | false | defaults to  ``` ./app/module.properties ``` (legacy parameter when Config.json is used) |

Increments the buildnumber in the apps property file. It also tags and pushes the changes using to the given branch.

### Build apk ``` smf_build_apk ```

| Parameter | Required | Note  |
|---|---|---|
| build_variant | true |  |

### Pull keystore ``` smf_pull_keystore ```

| Parameter | Required | Note  |
|---|---|---|
| folder | true | for example ``` DBG ``` |

Pulls and decrypt the associated keystore from https://github.com/smartmobilefactory/Android-Keystores


### Upload ``` smf_upload_apk_to_hockey ```

| Parameter | Required | Note  |
|---|---|---|
| apkFile | true | for example ``` app-internal-alpha.apk ``` |
| hockeyAppId | true |  |

The decrypted keystore from ``` smf_pull_keystore ``` is automatically used to sign the app if present.

### Generate MetaJson ``` smf_generate_meta_json ```

| Parameter | Required | Note  |
|---|---|---|
| branch | true |  |

Generates the MetaJson files for this project using https://github.com/smartmobilefactory/Android-MetaJSON-Plugin
The plugin must be added to gradle

### PhraseApp ``` sync_with_phrase_app ```

| Parameter | Required | Note  |
|---|---|---|
| branch | true |  |
| project_id | true | the apps project id |
| languages | true | the apps language codes codes mapped to the language key entered in phrase app |

```ruby
sync_with_phrase_app(
  branch: branch,
  project_id: "259be60207ab4faaea5a60d36a63637b",
  languages: {
    "default" => "en",
    "de" => "de-DE",
    "nl" => "nl",
    "es" => "Spanisch",
    "it" => "Italienisch"
  }
)
```

### PR check with Danger ``` smf_danger_build_pr ```

| Parameter | Required | Note  |
|---|---|---|
| jira_key | false | the prefix of a jira ticket for the project you are working on |
| modules.gradle_build_task | false | the gradle task to check if the build does not fail |
| modules.gradle_lint_task | false | the gradle task to run android lint |
| modules.module_name | false | prefix for path th report output, defaults to "app" |
| modules.run_detekt | false | defaults to `true` |
| modules.run_ktlint | false | defaults to `true` |
| modules.junit_task | false | the gradle task to run the junit tests (relies on the module_basepath) |


```ruby
smf_danger_build_pr(
  jira_key: "SMFCI",
  modules: [
    {
      "gradle_build_task" => "assembleDebug",
      "gradle_lint_task" => "lintDebug",
      "module_name" => "app",
      "run_detekt" => false,
      "run_ktlint" => true,
      "junit_task" => testDebugUnitTest
    }
  ]
)
```

## Config.json
Every Project is expected to have a Config.json file at the root folder

```json
{
  "app_version_code": 125,
  "project": {
    "type": "app",
    "jira_key": "SMFIT",
    "slack_channel": "ci-playground",
    "name": "CI-Android-Playground"
  },
  "ci_build_variants": [
    "Alpha",
    "Beta",
    "Live"
  ],
  "hockey": {
    "alpha": "ID1",
    "beta": "ID2",
    "live": "ID3"
  }
}
```

| Parameter |  Note  |
|---|---|
| app_version_code | used by fastlane to track and increment the apps versions code. This field should also be used in the apps build.gradle |
| project.type | can be one of {app, framework} which specifies what templates should be generated by fastlane |
| project.jira_key | the jira project which is accociated with the project |
| project.slack_channel | the slack channel project which is accociated with the project |
| project.name | displayable name of the project |
| ci_build_variants | defines what variants should be avaiable in the Jenkins UI |
| hockey | contains all hockey app ids which should be references in the apps Fastfile and the apps build.gradle file |


